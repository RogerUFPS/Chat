package dao;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;

import model.Message;
import model.PrivateChat;
import model.User;

public class ChatDAO{

	private Connection con;
	
	public ChatDAO() {
		try {
			con = DriverManager.getConnection("jdbc:h2:~/chat", "admin", "a");
		} catch (SQLException e) {
			System.err.println("La conexión no se pudo establecer. " + e.getMessage());
		}
	}
	
	public void sendMessage(String message, User transmitter, User receiver) {
		try {
			Statement statementOb = con.createStatement();

			String sqlString = "INSERT INTO CHATS (MESSAGES, SENDER, RECEIVER) values " + "('" + message + "', "
					+ transmitter + "," + receiver + ")";
			statementOb.executeUpdate(sqlString);
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			try {
				con.close();
			} catch (SQLException sqle) {
				sqle.printStackTrace();
			}
		}
	}
	
	public ArrayList<PrivateChat> getPrivateChat(User u) {
		
		ArrayList<PrivateChat> privateChats = new ArrayList<PrivateChat>();
		try {
			Statement statementOb = con.createStatement();
			ResultSet r = statementOb.executeQuery("SELECT * FROM CHATS WHERE SENDER='"+u.getUsername()+" OR RECEIVER="+u.getUsername()+"' ORDER BY DATE");

				
			PrivateChat chat = new PrivateChat();
			
			for(r.next()) {
				String sender = r.getString("SENDER");
				String receiver = r.getString("RECEIVER");
				String msg = r.getString("MESSAGE");
				Message m = new Message();
				m.setSender(sender);
				m.setMessage(msg);
				chat.setReceiver(receiver);
				chat.sendMessage(m);
			}
		
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			try {
				con.close();
			} catch (SQLException sqle) {
				sqle.printStackTrace();
			}
		}
		
		return privateChats;
	}
	
	public Message getMessage(User receiver) {
		Message m = null;
		try {
			Statement statementOb = con.createStatement();
			ResultSet r = statementOb.executeQuery("SELECT * FROM CHATS WHERE SENDER='"+receiver.getUsername()+"'");
			//Falta conseguir también los mensajes pero del Receiver xd
		
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			try {
				con.close();
			} catch (SQLException sqle) {
				sqle.printStackTrace();
			}
		}
		return m;
	}
	
}